<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ</title>
<style>
  :root{--green:#16a34a;--ink:#0f172a;--muted:#64748b;--bg:#f1f5f9;--card:#fff}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:'Noto Kufi Arabic',system-ui,sans-serif;color:var(--ink)}
  .wrap{max-width:1080px;margin:18px auto;padding:0 12px}
  .top{background:var(--green);color:#fff;padding:14px 16px;border-radius:12px;font-weight:900;font-size:20px}
  .controls{display:flex;gap:8px;align-items:center;margin:12px 0}
  input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px}
  button{padding:10px 12px;border:none;border-radius:10px;background:#0ea5e9;color:#fff;font-weight:800;cursor:pointer}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{flex:1 1 260px;background:var(--card);border:1px solid #e5e7eb;border-radius:12px;padding:14px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
  .kpi{font-size:36px;font-weight:900;margin-top:6px}
  .muted{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px dashed #e5e7eb;text-align:start;font-size:13px}
  th{background:#f8fafc}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  canvas{width:100%;height:240px;display:block}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ</div>

  <div class="controls">
    <input id="pin" placeholder="PIN" value="bassam1234">
    <button id="load">Ø¹Ø±Ø¶</button>
    <button id="export">ØªØµØ¯ÙŠØ±</button>
    <button id="clear">ØªÙØ±ÙŠØº</button>
    <span class="muted" id="msg"></span>
  </div>

  <div class="row">
    <div class="card"><div class="muted">Ø£Ø¬Ù‡Ø²Ø© ÙØ±ÙŠØ¯Ø©</div><div class="kpi" id="kpi_devices">â€“</div></div>
    <div class="card"><div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div><div class="kpi" id="kpi_events">â€“</div></div>
    <div class="card"><div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨Ø­Ø«</div><div class="kpi" id="kpi_searches">â€“</div></div>
  </div>

  <div class="row">
    <div class="card" style="flex:2 1 520px">
      <div class="muted">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙˆØ§Ù„Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ… (Ø¢Ø®Ø± 14 ÙŠÙˆÙ…)</div>
      <canvas id="chart"></canvas>
    </div>
    <div class="card" style="flex:1 1 280px">
      <div class="muted">Ø£Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¨Ø­Ø«</div>
      <table id="top"><tr><th>Ø§Ù„ÙƒÙ„Ù…Ø©</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th></tr></table>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="muted" style="margin-bottom:6px">Ø¢Ø®Ø± 20 Ø­Ø¯Ø«Ù‹Ø§</div>
    <table id="latest">
      <tr>
        <th>Ø§Ù„ÙˆÙ‚Øª (UTC)</th><th>Ø§Ù„Ù€ IP</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th>Ø§Ù„ÙƒÙ„Ù…Ø©/Ø§Ù„Ù…Ø³Ø§Ø±</th><th>Ø§Ù„Ù…ØªØµÙØ­</th>
      </tr>
    </table>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const pin=$('pin'), btn=$('load'), msg=$('msg');
const kpi_devices=$('kpi_devices'), kpi_events=$('kpi_events'), kpi_searches=$('kpi_searches');
const topTbl=$('top'), chartEl=$('chart'), latestTbl=$('latest');
const btnExport=$('export'), btnClear=$('clear');

btn.addEventListener('click', loadStats);
btnExport.addEventListener('click', ()=>open('/export?pin='+encodeURIComponent(pin.value), '_blank'));
btnClear.addEventListener('click', async ()=>{
  if(!confirm('Ø³ÙŠØªÙ… ØªÙØ±ÙŠØº ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
  const r = await fetch('/clear?pin='+encodeURIComponent(pin.value), {method:'POST'});
  if(r.ok){ msg.textContent='ØªÙ… Ø§Ù„ØªÙØ±ÙŠØº.'; await loadStats(); } else { msg.textContent='ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªÙØ±ÙŠØº.'; }
});

async function loadStats(){
  msg.textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦';
  try{
    const r = await fetch('/stats?pin='+encodeURIComponent(pin.value));
    if(!r.ok) throw new Error('PIN Ø£Ùˆ ØµÙ„Ø§Ø­ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    const data = await r.json();

    kpi_devices.textContent = data.unique_devices ?? 0;
    kpi_events.textContent  = data.total_events ?? 0;
    kpi_searches.textContent= data.total_searches ?? 0;

    // Ø£Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¨Ø­Ø«
    topTbl.innerHTML = '<tr><th>Ø§Ù„ÙƒÙ„Ù…Ø©</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th></tr>' +
      (data.top_searches||[]).map(x=>`<tr><td>${escapeHtml(x.q)}</td><td>${x.count}</td></tr>`).join('') ||
      '<tr><td colspan="2">Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';

    // Ø¢Ø®Ø± 20 Ø­Ø¯Ø«
    latestTbl.innerHTML = `
      <tr><th>Ø§Ù„ÙˆÙ‚Øª (UTC)</th><th>Ø§Ù„Ù€ IP</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th>Ø§Ù„ÙƒÙ„Ù…Ø©/Ø§Ù„Ù…Ø³Ø§Ø±</th><th>Ø§Ù„Ù…ØªØµÙØ­</th></tr>
      ${renderLatest(data.latest||[])}
    `;

    // Ø§Ù„Ø±Ø³Ù…
    drawBars(chartEl, data.daily||[], {a:'unique_devices', b:'searches'});

    msg.textContent='ØªÙ….';
  }catch(e){
    msg.textContent='ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: '+e.message;
  }
}

function renderLatest(list){
  return list.map(e=>{
    const p = e.payload||{};
    const qp = p.q ? `ğŸ” ${escapeHtml(p.q)}` : (p.path? `ğŸ“„ ${escapeHtml(p.path)}` : '');
    return `<tr>
      <td class="mono">${escapeHtml(e.ts||'')}</td>
      <td class="mono">${escapeHtml(e.ip||'-')}</td>
      <td>${escapeHtml(e.event||'-')}</td>
      <td>${qp}</td>
      <td title="${escapeHtml(e.ua||'')}">${escapeHtml(String(e.ua||'').slice(0,38))}â€¦</td>
    </tr>`;
  }).join('');
}

function escapeHtml(s){return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}

function drawBars(canvas, daily, keys){
  const d = daily.slice(-14);
  const labels = d.map(x=>x.date);
  const A = d.map(x=>+x[keys.a]||0);
  const B = d.map(x=>+x[keys.b]||0);
  const W = canvas.clientWidth, H = canvas.clientHeight;
  canvas.width = W * devicePixelRatio; canvas.height = H * devicePixelRatio;
  const ctx = canvas.getContext('2d'); ctx.scale(devicePixelRatio, devicePixelRatio);
  ctx.clearRect(0,0,W,H);

  const max = Math.max(1, ...A, ...B);
  const pad = 28, innerW = W - pad*2, innerH = H - pad*2;
  const n = labels.length || 1, groupW = innerW / n;

  ctx.strokeStyle = '#e5e7eb';
  ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.stroke();

  for(let i=0;i<n;i++){
    const x0 = pad + i*groupW;
    const w  = Math.max(6, groupW*0.36);
    const gap= groupW*0.08;

    const hA = innerH * (A[i]/max);
    const hB = innerH * (B[i]/max);

    ctx.fillStyle = '#86efac'; ctx.fillRect(x0 + gap, H - pad - hA, w, hA);
    ctx.fillStyle = '#93c5fd'; ctx.fillRect(x0 + gap + w + gap, H - pad - hB, w, hB);

    ctx.fillStyle = '#64748b'; ctx.font = '10px system-ui';
    const lbl = String(labels[i]||'').slice(5);
    ctx.fillText(lbl, x0 + gap, H - pad + 12);
  }
}

loadStats();
</script>
</body>
</html>
