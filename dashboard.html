<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ â€” Ø¨Ø³Ø§Ù… ØªØ±Ø§ÙƒØ±</title>
<style>
  :root{--green:#16a34a;--ink:#0f172a;--muted:#64748b;--bg:#f1f5f9;--card:#fff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Noto Kufi Arabic',system-ui,sans-serif;color:var(--ink)}
  .wrap{max-width:980px;margin:18px auto;padding:0 12px}
  .top{background:var(--green);color:#fff;padding:14px 16px;border-radius:12px;font-weight:900;font-size:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .card{flex:1 1 220px;background:var(--card);border:1px solid #e5e7eb;border-radius:12px;padding:14px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
  .kpi{font-size:36px;font-weight:900;margin-top:6px}
  .muted{color:var(--muted);font-size:12px}
  .controls{display:flex;gap:8px;align-items:center;margin-top:12px}
  input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px}
  button{padding:10px 12px;border:none;border-radius:10px;background:#0ea5e9;color:#fff;font-weight:800;cursor:pointer}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px dashed #e5e7eb;text-align:start}
  canvas{width:100%;height:220px;display:block}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ</div>

  <div class="controls">
    <input id="pin" placeholder="PIN" value="bassam1234">
    <button id="load">Ø¹Ø±Ø¶</button>
    <span class="muted" id="msg"></span>
  </div>

  <div class="row">
    <div class="card"><div class="muted">Ø£Ø¬Ù‡Ø²Ø© ÙØ±ÙŠØ¯Ø©</div><div class="kpi" id="kpi_devices">â€“</div></div>
    <div class="card"><div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div><div class="kpi" id="kpi_events">â€“</div></div>
    <div class="card"><div class="muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨Ø­Ø«</div><div class="kpi" id="kpi_searches">â€“</div></div>
  </div>

  <div class="row">
    <div class="card" style="flex:2 1 420px"><div class="muted">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙˆØ§Ù„Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…</div><canvas id="chart"></canvas></div>
    <div class="card" style="flex:1 1 260px"><div class="muted">Ø£Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¨Ø­Ø«</div><table id="top"></table></div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const pin=$('pin'), btn=$('load'), msg=$('msg');
const kpi_devices=$('kpi_devices'), kpi_events=$('kpi_events'), kpi_searches=$('kpi_searches');
const topTbl=$('top'); const chartEl=$('chart');

btn.addEventListener('click', async ()=>{
  msg.textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦';
  try{
    const r = await fetch(`/stats?pin=${encodeURIComponent(pin.value)}`);
    if(!r.ok) throw new Error('Ø®Ø·Ø£ '+r.status);
    const data = await r.json();
    kpi_devices.textContent=data.unique_devices??0;
    kpi_events.textContent=data.total_events??0;
    kpi_searches.textContent=data.total_searches??0;
    const rows=(data.top_searches||[]).map(x=>`<tr><td>${x.q}</td><td>${x.count}</td></tr>`);
    topTbl.innerHTML='<tr><th>Ø§Ù„ÙƒÙ„Ù…Ø©</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th></tr>'+rows.join('');
    drawBars(data.daily||[]);
    msg.textContent='ØªÙ… âœ…';
  }catch(e){ msg.textContent='ÙØ´Ù„: '+e.message; }
});

function drawBars(d){
  const c=chartEl.getContext('2d'); c.clearRect(0,0,chartEl.width,chartEl.height);
  chartEl.width=chartEl.clientWidth; chartEl.height=chartEl.clientHeight;
  const A=d.map(x=>x.unique_devices), B=d.map(x=>x.searches), labels=d.map(x=>x.date.slice(5));
  const max=Math.max(1,...A,...B), W=chartEl.width, H=chartEl.height, pad=20, n=A.length;
  const g=(W-pad*2)/n;
  for(let i=0;i<n;i++){
    const x=pad+i*g, hA=(A[i]/max)*(H-pad*2), hB=(B[i]/max)*(H-pad*2);
    c.fillStyle='#86efac'; c.fillRect(x,H-pad-hA,g/3,hA);
    c.fillStyle='#93c5fd'; c.fillRect(x+g/3+2,H-pad-hB,g/3,hB);
    c.fillStyle='#64748b'; c.fillText(labels[i],x,H-pad+10);
  }
}
</script>
</body>
</html>
